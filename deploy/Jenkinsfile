pipeline {
    agent any

    environment {
        NODE_ENV = "production"

        // Docker Registry ì„¤ì •
        DOCKER_REGISTRY = "${env.CUSTOM_DOCKER_REGISTRY}"
        DOCKER_CREDENTIALS = "${env.CUSTOM_DOCKER_CREDENTIALS}"
        DOCKER_IMAGE = 'mangler/docgen-frontend'
        CONTAINER_NAME = 'mangler-docgen-frontend'
        DOCKERFILE_PATH = "deploy/Dockerfile"   // Dockerfile ê²½ë¡œ
        
        ENV_FILE_CREDENTIALS_ID = "MANGLER_DOCGEN_FRONT_ENV_FILE"
    }

    tools {
        nodejs 'node-v20.19.4'
    }

    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo "ğŸ“¥ Git ì €ì¥ì†Œì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
                git branch: 'main', url: 'https://github.com/AICC-Mangler/docgen-frontend.git'
            }
        }

        stage('ğŸ“¦ Install Dependencies') {
            steps {
                sh '''
                echo "ğŸ“¦ React + Vite + TypeScript ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"

                rm -rf node_modules

                if [ -f package-lock.json ]; then
                    echo "ğŸ”’ package-lock.json ì¡´ì¬ -> npm ci ì‚¬ìš©"
                    npm ci --include=dev --prefer-offline --no-audit --no-fund --progress=false
                else
                    echo "âš ï¸ package-lock.json ì—†ìŒ -> npm install ì‚¬ìš©"
                    npm install --include=dev --prefer-offline --no-audit --no-fund --progress=false
                fi

                # ì„¤ì¹˜ í™•ì¸
                if [ -f node_modules/.bin/vite ]; then
                    echo "ğŸ“‹ Vite ë°”ì´ë„ˆë¦¬ í™•ì¸ ì™„ë£Œ"
                else
                    echo "âš ï¸ Vite ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"
                fi

                if [ -f node_modules/.bin/tsc ]; then
                    echo "ğŸ“‹ TypeScript ë°”ì´ë„ˆë¦¬ í™•ì¸ ì™„ë£Œ"
                else
                    echo "âš ï¸ TypeScript ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"
                fi

                echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
                '''
            }
        }

        stage('.env file ìƒì„±'){
            steps{
                script{
                    withCredentials([
                            file(credentialsId: ENV_FILE_CREDENTIALS_ID, variable: 'ENV_FILE')
                        ]) {
                            sh '''
                                echo "ğŸ“„ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬ ì¤‘"
                                cp "\$ENV_FILE" .env
                                chmod 644 .env
                                
                                echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ë° ì •ë¦¬ ì™„ë£Œ"
                                echo "ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‚´ìš© í™•ì¸:"
                                cat .env | head -10
                            '''
                        }
                    }
            }
        }

        stage('ğŸ—ï¸ Build NestJS') {
            steps {
                sh '''
                    echo "ğŸ—ï¸ React + Vite + TypeScript ë¹Œë“œ ì‹œì‘"

                    # ë¹Œë“œ ì‚°ì¶œë¬¼ ì œê±°
                    rm -rf dist

                    # Vite ë¹Œë“œ
                    npm run build

                    # ë¹Œë“œ í™•ì¸
                    if [ -d "dist" ]; then
                        echo "âœ… ë¹Œë“œ ì™„ë£Œ: dist í´ë” ìƒì„±ë¨"
                        ls -la dist
                    else
                        echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: dist í´ë”ê°€ ì—†ìŒ"
                        exit 1
                    fi
                '''
            }
        }

        // stage('ğŸ§ª Test') {
        //     steps {
        //         sh '''
        //             echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
        //             npm run test || echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ë ¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬)"
        //         '''
        //     }
        // }

        stage('ğŸ³ Docker Build') {
            steps {
                script {
                    try {
                        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"

                        def app = docker.build("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}", "-f ${DOCKERFILE_PATH} .")

                        // ë¹Œë“œ ì„±ê³µ ì‹œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                        env.DOCKER_BUILD_SUCCESS = 'true'
                        env.DOCKER_IMAGE_TAG = "${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"

                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ"
                        echo "ğŸ“¦ ì´ë¯¸ì§€ íƒœê·¸: ${env.DOCKER_IMAGE_TAG}"

                    } catch (Exception e) {
                        env.DOCKER_BUILD_SUCCESS = 'false'
                        error "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        stage('ğŸ“¤ Push Docker Image') {
            when {
                environment name: 'DOCKER_BUILD_SUCCESS', value: 'true'
            }
            steps {
                script {
                    try {
                        docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                            def app = docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}")
                            app.push("${BUILD_NUMBER}")

                            // main ë¸Œëœì¹˜ëŠ” latest íƒœê·¸ë„ í‘¸ì‹œ
                            def currentBranch = env.GIT_BRANCH ?: 'develop'
                            if (currentBranch.contains('main')) {
                                app.push("latest")
                                echo "âœ… latest íƒœê·¸ í‘¸ì‹œ ì™„ë£Œ"
                            }
                        }

                        env.DOCKER_PUSH_SUCCESS = 'true'
                        echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    } catch (Exception e) {
                        env.DOCKER_PUSH_SUCCESS = 'false'
                        echo "âŒ Docker Registry ì¸ì¦ ë˜ëŠ” í‘¸ì‹œ ì‹¤íŒ¨: ${e.getMessage()}"
                        echo "ğŸ” Docker Registry: ${DOCKER_REGISTRY}"
                        echo "ğŸ” Credentials ID: ${DOCKER_CREDENTIALS}"
                        error "Docker í‘¸ì‹œ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }
        stage('ğŸš€ Deploy') {
            when {
                environment name: 'DOCKER_PUSH_SUCCESS', value: 'true'
            }
            steps {
                script {
                    def currentBranch = env.CURRENT_BRANCH ?: env.BRANCH_NAME ?: 'main'
                    def deployEnv = currentBranch.contains('main') ? 'production' : 'development'
                    def containerName = "${CONTAINER_NAME}-${deployEnv}"
                    def containerPort = deployEnv == 'production' ? '8181' : '3001'
                    def dockerNetwork = 'demo-net'

                    echo "ğŸš€ ë°°í¬ ì‹œì‘: ${deployEnv} í™˜ê²½"
                    echo "ğŸ“¦ ì»¨í…Œì´ë„ˆ: ${containerName}"
                    echo "ğŸ”Œ í¬íŠ¸: ${containerPort}"
                    echo "ğŸ“¦ ì´ë¯¸ì§€: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"

                    try {
                        // Docker Registry ì¸ì¦ í›„ ì´ë¯¸ì§€ pull
                        docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                            sh "docker pull ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"
                        }

                        sh """
                            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
                            docker stop ${containerName} || true
                            docker rm ${containerName} || true
                            
                            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                            docker run -d \\
                                --name ${containerName} \\
                                --network ${dockerNetwork} \\
                                --restart unless-stopped \\
                                --label "app=nestjs-backend" \\
                                --label "env=${deployEnv}" \\
                                --label "version=${BUILD_NUMBER}" \\
                                --label "branch=${currentBranch}" \\
                                --label "commit=${env.GIT_COMMIT_SHORT}" \\
                                --env-file .env \\
                                -p ${containerPort}:80 \\
                                ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}

                            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                            sleep 5
                            docker ps | grep ${containerName}
                            echo "âœ… ì»¨í…Œì´ë„ˆ ${containerName} ë°°í¬ ì™„ë£Œ"
                        """

                        env.DEPLOY_SUCCESS = 'true'

                    } catch (Exception e) {
                        env.DEPLOY_SUCCESS = 'false'
                        echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                        error "ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                    }

                    // ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬
                    if (env.DEPLOY_SUCCESS == 'true') {
                        sh """
                            echo "ğŸ” í—¬ìŠ¤ ì²´í¬ ì‹œì‘"
                            sleep 5
                            for i in \$(seq 1 10); do
                                if curl -f http://localhost:${containerPort} > /dev/null 2>&1; then
                                    echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
                                    break
                                else
                                    echo "â³ ëŒ€ê¸° ì¤‘... (\$i/10)"
                                    sleep 3
                                fi
                            done
                        """
                    }
                }
            }
        }
    }

    

    post {
        success {
            echo "âœ… Pipeline ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
        }
        failure {
            echo "âŒ Pipeline ì‹¤íŒ¨"
        }
    }
}